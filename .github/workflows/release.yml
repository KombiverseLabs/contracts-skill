name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Example Contracts
        shell: pwsh
        run: |
          ./skill/scripts/validate-contracts.ps1 -Path "./examples/sample-project" -OutputFormat github-actions

      - name: Check PowerShell script syntax
        shell: pwsh
        run: |
          $paths = @(
            './setup.ps1',
            './installers/install.ps1'
          )
          foreach ($p in $paths) {
            $content = Get-Content $p -Raw
            [scriptblock]::Create($content) | Out-Null
            Write-Host "✅ $p syntax valid"
          }

      - name: PSScriptAnalyzer (installers + setup)
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
          Import-Module PSScriptAnalyzer
          $paths = @(
            './setup.ps1',
            './installers/install.ps1'
          )
          $issues = Invoke-ScriptAnalyzer -Path $paths -Severity Warning,Error
          if ($issues) {
            $issues | Select-Object RuleName,Severity,ScriptName,Line,Message | Format-Table -AutoSize
            throw "PSScriptAnalyzer found $($issues.Count) issue(s)."
          }
          Write-Host '✅ PSScriptAnalyzer clean'

      - name: Check Bash script syntax
        shell: bash
        run: |
          bash -n ./setup.sh
          bash -n ./installers/install.sh
          echo "✅ bash script syntax valid"

      - name: Check minimal-ui JavaScript syntax
        shell: bash
        run: |
          node -e "const fs=require('fs');const h=fs.readFileSync('skill/ui/minimal-ui/index.html','utf8');const m=h.match(/<script>([\\s\\S]*?)<\\/script>/i); if(!m) throw new Error('No <script> found'); new Function(m[1]); console.log('✅ minimal-ui JS syntax valid');"

  github-release:
    needs: validate
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
